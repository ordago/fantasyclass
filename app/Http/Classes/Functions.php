<?php

namespace App\Http\Classes;

use App\Student;
use Google_Service_Drive_AboutDriveThemes;

class Functions
{

  public static function getProbability($success) {
    $v = rand(0, 99);
    if($v < $success) {
      return true;
    } return false;
  }
  /***
   * Replace special chars
   */
  public static function replaceSpecial($text, $class = null)
  {
    // $text = str_replace('[tex]', '\[', $text);
    // $text = str_replace('[/tex]', '\]', $text);
    $text = str_replace('%XP%', "<i class='fas fa-fist-raised colored'></i>", $text);
    $text = str_replace('%GOLD%', "<i class='fas fa-coins colored'></i>", $text);
    $text = str_replace('%HP%', "<i class='fas fa-heart colored'></i>", $text);
    $text = str_replace('%BR%', "<br>", $text);
    $text = str_replace('%br%', "<br>", $text);

    if ($class) {
      settings()->setExtraColumns(['classroom_id' => $class->id]);

      $text = str_replace('%GAME_NAME%', $class->adventure_name, $text);
      $text = str_replace('%GOLD_USE%', settings()->get('card_use', 200), $text);
      $text = str_replace('%GOLD_DELETE%', settings()->get('card_delete', 50), $text);
      $text = str_replace('%NUM_CARDS%', settings()->get('num_cards', 5), $text);
    }

    return $text;
  }

  public static function simple_crypt( $string, $action = 'e' ) {

    $secret_key = env('SECRET_CRYPT');
    $secret_iv = 'SECRET_CRYPT_IV';

    $output = false;
    $encrypt_method = "AES-256-CBC";
    $key = hash( 'sha256', $secret_key );
    $iv = substr( hash( 'sha256', $secret_iv ), 0, 16 );

    if( $action == 'e' ) {
        $output = base64_encode( openssl_encrypt( $string, $encrypt_method, $key, 0, $iv ) );
    }
    else if( $action == 'd' ){
        $output = openssl_decrypt( base64_decode( $string ), $encrypt_method, $key, 0, $iv );
    }

    return $output;
}

  /***
   * Returns the current class student
   */
  public static function getCurrentStudent($classroom, $with = ['equipment', 'classroom', 'behaviours', 'items'])
  {
    if (session()->get('bypass_student')) {
      $student = Student::where('id', '=', session()->get('bypass_student'))->with($with)->first();
      if($student->classroom->classroom_id == $classroom->id)
        return $student;
      abort(403);
    }

    $class = auth()->user()->classrooms
      ->where('pivot.classroom_id', '=', $classroom->id)
      ->where('pivot.role', '=', 0)
      ->first();

    if($class) {
      return Student::where(
        'id',
        '=',
        $class->pivot->student->id
      )->with($with)->first();
    }
    abort(403, "Are you a teacher? This link is only for students");
  }

  /**
   * getRandomWeightedElement()
   * Utility function for getting random values with weighting.
   * Pass in an associative array, such as array('A'=>5, 'B'=>45, 'C'=>50)
   * An array like this means that "A" has a 5% chance of being selected, "B" 45%, and "C" 50%.
   * The return value is the array key, A, B, or C in this case.  Note that the values assigned
   * do not have to be percentages.  The values are simply relative to each other.  If one value
   * weight was 2, and the other weight of 1, the value with the weight of 2 has about a 66%
   * chance of being selected.  Also note that weights should be integers.
   * 
   * @param array $weightedValues
   */
  public static function getRandomWeightedElement(array $weightedValues)
  {
    $rand = mt_rand(1, (int) array_sum($weightedValues));

    foreach ($weightedValues as $key => $value) {
      $rand -= $value;
      if ($rand <= 0) {
        return $key;
      }
    }
  }
}
